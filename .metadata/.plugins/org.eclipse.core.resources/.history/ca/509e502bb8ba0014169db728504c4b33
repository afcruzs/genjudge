package unal.edu.gpj

import java.text.DateFormat

class AdminController {

    def index() { }
	
	def uploadProblem(){}
	
	def doUploadProblem(){
		
		def bytesFile = request.getFile('file').getBytes()
		def name = params.titleInput
		def time = Long.parseLong(params.time)
		def newProblem = new Problem(name:name,pdfDescription:bytesFile,timeToAnswer:time)
		
		def inputCases = request.getMultiFileMap().input
		def outputCases = request.getMultiFileMap().output
		
		
		if( inputCases.size() != outputCases.size() ) {
			render "PLease upload the same amount of input/output files"
		}else{
			inputCases = inputCases.sort{a,b -> a.getOriginalFilename().toLowerCase() <=> b.getOriginalFilename().toLowerCase()}
			outputCases = outputCases.sort{a,b -> a.getOriginalFilename().toLowerCase() <=> b.getOriginalFilename().toLowerCase()}
			
			
			for(int i=0; i<inputCases.size(); i++){
				TestCase testCase = new TestCase(
					inputFile:inputCases[i].getBytes(),
					outputFile:outputCases[i].getBytes()
					)
				newProblem.addToTestCases(testCase)
			}
			newProblem.save()
			redirect(action:'index')
		}
	}
	
	def createContest(){
		render( view: "createContest", model : [ problems : Problem.list() ] )
	}
	
	def doCreate(){
		DateFormat df = DateFormat.getDateInstance();
		Date startDate = df.parse(params.dp1)
		Date endDate = df.parse(params.dp2)
		String name = params.titleInput
		
		Contest newContest = new Contest(name:name,startDate:startDate,finishDate:endDate)
		for(String s : params.keySet()){
			if( s.isNumber() )
				newContest.addToProblems(Problem.get(Long.parseLong(s)))
		}
		
		//Adds ALL the users to any contest :)
		for( User user : User.list() ){
			newContest.addToUsers(user)
		}
		
		newContest.save()
		redirect(action:'index')
	}
	
	def testProblem(){
		
		def xd = Problem.list()
		def lol = xd.get(0)
		render( view: "testProblem", model : [ problem : lol ] )
		
	}
	
	def getPdf(){
		println "ENtro!!"
		Problem p = Problem.get(params.id)
		if (!p|| !p.pdfDescription || !p.pdfDescription ) {
		  println "ERROOOOOOOOOOOOOORRR"
		  response.sendError(404)
		  return
		}
		response.contentType = p.pdfDescription
		response.contentLength = p.pdfDescription.size()
		
		
		response.setContentType("application/pdf")
        OutputStream out = response.getOutputStream()
        out << p.pdfDescription
        out.flush()
	}

	
	def xd(){
		render Problem.list().size()
	}
	
	def seeContest(){
		def contest = Contest.get(params.contestId)
		def standings = [:]
		for( User user : contest.users ){
			standings[user.username] = []
		}
		for( User user : contest.users ){
			for( Problem problem : contest.problems ){
				def userDownloads = contest.downloads.findAll{ down -> down.user.id == user.id }
				if( userDownloads != null && userDownloads.size() > 0 ){
					def submissions = contest.submission.findAll{ submission -> submission.user.id == user.id }
					def latestSubmission = submissions.max{ it.date }
					
					if( latestSubmission.correct )
						standings[user.username] = "ac"
					else if( latestSubmission.timeLimitExceeded )
						standings[user.username] = "tle"
					else
						standings[user.username] = "wa"
					
					
				}else{
					standings[user.username] = "nothing"
				}
			}
		}
		println standings
		render(view:'seeContest',model : [ standings : standings, users : contest.users ])
		
	}
}
